name: Build VitePress and Push to Private Repo

on:
    push:
        branches: [main]
    workflow_run:
        workflows: ["Case Sensitivity Check"]
        types:
            - completed
        branches: [main]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        # Only skip if workflow_run event and the case check failed
        if: |
            github.event_name == 'push' || 
            (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
        steps:
            - name: Wait for case sensitivity check (push events only)
              if: github.event_name == 'push'
              run: |
                echo "â³ Waiting for case sensitivity check to complete..."
                
                # Get the latest workflow run for case sensitivity check
                WORKFLOW_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  "https://api.github.com/repos/${{ github.repository }}/actions/workflows" | \
                  jq -r '.workflows[] | select(.name == "Case Sensitivity Check") | .id')
                
                if [ "$WORKFLOW_ID" = "null" ] || [ -z "$WORKFLOW_ID" ]; then
                  echo "âš ï¸ Case sensitivity workflow not found, proceeding with build"
                  exit 0
                fi
                
                echo "ğŸ” Found case sensitivity workflow ID: $WORKFLOW_ID"
                
                # Wait for the workflow to complete (max 10 minutes)
                for i in {1..60}; do
                  LATEST_RUN=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?per_page=1&branch=main")
                  
                  STATUS=$(echo "$LATEST_RUN" | jq -r '.workflow_runs[0].status')
                  CONCLUSION=$(echo "$LATEST_RUN" | jq -r '.workflow_runs[0].conclusion')
                  
                  echo "ğŸ“Š Case sensitivity check status: $STATUS, conclusion: $CONCLUSION"
                  
                  if [ "$STATUS" = "completed" ]; then
                    if [ "$CONCLUSION" = "success" ]; then
                      echo "âœ… Case sensitivity check completed successfully"
                      exit 0
                    else
                      echo "âŒ Case sensitivity check failed with conclusion: $CONCLUSION"
                      exit 1
                    fi
                  fi
                  
                  echo "â³ Still waiting... (attempt $i/60)"
                  sleep 10
                done
                
                echo "â° Timeout waiting for case sensitivity check"
                exit 1

            - name: Checkout the code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  # Ensure we get the latest changes after case sensitivity fixes
                  ref: ${{ github.ref }}

            - name: Verify repository state
              run: |
                echo "ğŸ” Verifying repository state after case sensitivity fixes..."
                echo "ğŸ“Š Event: ${{ github.event_name }}"
                
                # Check for any remaining case conflicts
                CONFLICTS=$(git ls-files | sort -f | uniq -i -d || true)
                
                if [ -n "$CONFLICTS" ]; then
                  echo "âš ï¸ Warning: Case conflicts still detected:"
                  echo "$CONFLICTS"
                  echo "Proceeding with build anyway..."
                else
                  echo "âœ… No case conflicts detected, repository is clean"
                fi
                
                echo "ğŸ“Š Repository status:"
                echo "- Branch: $(git branch --show-current)"
                echo "- Latest commit: $(git log -1 --oneline)"
                echo "- Total files: $(git ls-files | wc -l)"

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20.17.0"
                  cache: 'yarn'

            - name: Configure Yarn
              run: yarn config set registry https://registry.npmmirror.com

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Build VitePress site
              env:
                NODE_OPTIONS: --max-old-space-size=8192
              run: |
                  echo "ğŸ—ï¸ Building VitePress site..."
                  yarn docs:build
                  echo "âœ… VitePress site build completed"

            - name: Copy deployment workflow
              run: |
                  # åˆ›å»ºç›®æ ‡ç›®å½•
                  mkdir -p .vitepress/dist/.github/workflows/
                  
                  # å…‹éš†åŒ…å«éƒ¨ç½²workflowçš„ä»“åº“
                  git clone --depth 1 https://${{ secrets.PICKAID_TOKEN }}@github.com/M1hono/CrychicDocWorkflow.git workflow_repo
                  
                  # å¤åˆ¶éƒ¨ç½²workflow
                  cp workflow_repo/.github/workflows/deploy.yml .vitepress/dist/.github/workflows/
                  
                  # æ¸…ç†ä¸´æ—¶ç›®å½•
                  rm -rf workflow_repo
                  
                  echo "ğŸ“‹ Deployment workflow copied successfully"

            - name: Push to private repo
              run: |
                  cd .vitepress/dist
                  git init
                  
                  # åœ¨å­ç›®å½•ä¸­è®¾ç½®gité…ç½®
                  git config user.name "GitHub Actions Bot"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  
                  git add -A
                  git commit -m "Update documentation (after case sensitivity fixes)"
                  git push --force https://${{ secrets.PICKAID_TOKEN }}@github.com/M1hono/CrychicDocSynchronization.git HEAD:main
                  echo "ğŸš€ Push completed successfully"

            - name: Cleanup
              run: |
                  rm -rf .vitepress/dist
                  rm -rf workflow_repo
                  echo "ğŸ§¹ Cleanup completed"

            - name: Build summary
              run: |
                echo "ğŸ“Š Build Summary:"
                echo "âœ… Case sensitivity check: Passed"
                echo "âœ… Dependencies installation: Completed"
                echo "âœ… VitePress build: Completed"
                echo "âœ… Deployment: Completed"
                echo "ğŸ‰ All steps completed successfully!"